<!doctype html><html lang=en dir=" auto">
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta charset=utf-8>
<meta name=Share-Source-Verification content="https://blog.zhangyingwei.com/">
<meta http-equiv=cache-control content="no-transform">
<meta http-equiv=cache-control content="no-siteapp">
<meta name=renderer content="webkit">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta property="og:title" content="æ¢ç´¢ Kafka æ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ">
<meta property="og:image" content="/images/favicon64.ico">
<meta name=msvalidate.01 content="1B50C3A24BF817BB86D82C8429075AE4">
<meta name=bytedance-verification-code content="rjX6knbDoNxpR4Asxe2M">
<meta name=robots content="index, follow">
<title>æ¢ç´¢ Kafka æ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ | èƒ¡è¯´</title>
<meta name=keywords content="èƒ¡è¯´,é™æ€åšå®¢,å¼ è‹±ä¼Ÿ,å¼ è‹±ä¼Ÿçš„ä¸ªäººåšå®¢,SpringBoot,Java,Kafka">
<meta name=description content="åœ¨æ„å»ºåŸºäº Kafka çš„æ¶ˆæ¯å¤„ç†ç³»ç»Ÿä¸­ï¼Œæ¶ˆæ¯ä¸¢å¤±æ˜¯ä¸€ä¸ªéœ€è¦æ·±å…¥ç ”ç©¶çš„é‡è¦é—®é¢˜ã€‚å¼ºå¤§çš„ç³»ç»Ÿä¸ä»…ä¾èµ–äºå…¶åŠŸèƒ½ï¼Œè€Œä¸”ä¾èµ–äºå…¶å¯é æ€§ã€‚å› æ­¤ï¼Œç†è§£æ¶ˆæ¯ä¸¢å¤±çš„åŸå› ï¼Œå¹¶é‡‡å–å¿…è¦çš„æªæ–½ç¡®ä¿æ¶ˆæ¯çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ï¼Œæ˜¯æ„å»ºé«˜æ•ˆå¯é æ¶ˆæ¯ç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚æœ¬æ–‡å°†è¯¦ç»†åˆ†æ Kafka æ¶ˆæ¯ä¸¢å¤±çš„ä¸»è¦åŸå› ï¼Œå¹¶æä¾›ä¸€ç³»åˆ—ç­–ç•¥æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚
æ¶ˆæ¯ä¸¢å¤±çš„åŸå›   ç”Ÿäº§è€…ç«¯é—®é¢˜ï¼š åœ¨ Kafka ç³»ç»Ÿä¸­ï¼Œç”Ÿäº§è€…è´Ÿè´£å‘é€æ¶ˆæ¯ã€‚ç„¶è€Œï¼Œç”±äºç½‘ç»œæ•…éšœæˆ–å…¶ä»–æœªçŸ¥é—®é¢˜ï¼Œç”Ÿäº§è€…å¯èƒ½æ— æ³•æˆåŠŸå‘é€æ¶ˆæ¯åˆ° Kafka æœåŠ¡å™¨ã€‚ Kafka æœåŠ¡ç«¯é—®é¢˜ï¼š Kafka æœåŠ¡å™¨å¯èƒ½ä¼šå› ä¸ºç¡¬ä»¶æ•…éšœã€ç£ç›˜æ»¡æˆ–å…¶ä»–å¼‚å¸¸æƒ…å†µå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ã€‚ æ¶ˆè´¹è€…ç«¯é—®é¢˜ï¼š æ¶ˆè´¹è€…è´Ÿè´£å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯ã€‚ä½†æ˜¯ï¼Œæ¶ˆè´¹è€…åœ¨å¤„ç†æ¶ˆæ¯æ—¶å¯èƒ½ä¼šå‡ºç°é”™è¯¯æˆ–å´©æºƒï¼Œå¯¼è‡´æ¶ˆæ¯æœªè¢«æ­£ç¡®å¤„ç†ã€‚  è§£å†³æ–¹æ¡ˆä¸æªæ–½ ç”Ÿäº§è€…ç«¯ç›¸å…³æ–¹æ¡ˆä¸æªæ–½  å‘é€æ¶ˆæ¯å¤„ç†å›è°ƒæ–¹æ³•  ç”±äºæ¶ˆæ¯çš„å¸¸è§„å‘é€é‡‡ç”¨çš„å¼‚æ­¥æ–¹å¼ï¼Œæ‰€ä»¥é€šå¸¸ä¼šå¿½ç•¥æ‰å›è°ƒå¤„ç†ï¼Œä¸ºäº†ä¿è¯æ¶ˆæ¯çš„å‘é€è´¨é‡ï¼Œä¸€å®šéœ€è¦å¯¹å›è°ƒä¿¡æ¯è¿›è¡Œå¤„ç†æˆ–è€…æ”¹ä¸ºåŒæ­¥å‘é€ã€‚
producer.send(newÂ ProducerRecord<>(topic,Â messageKey,Â messageStr), newÂ CallBack({...}); è®¾ç½®æœ‰æ•ˆçš„é‡è¯•ç­–ç•¥ä»¥åŠ acks é…ç½®  æˆ‘ä»¬å¯ä»¥åœ¨ç”Ÿäº§è€…ç«¯è®¾ç½®ä¸€ä¸ªæœ‰æ•ˆçš„é‡è¯•ç­–ç•¥ï¼Œä¿è¯æ¶ˆæ¯æˆåŠŸå‘é€ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æŒ‡æ•°é€€é¿ç®—æ³•è¿›è¡Œé‡è¯•ã€‚è¿™ç§ç®—æ³•ä¼šåœ¨æ¯æ¬¡é‡è¯•å¤±è´¥åç­‰å¾…æ›´é•¿çš„æ—¶é—´ï¼Œä»è€Œå‡è½»æœåŠ¡å™¨çš„å‹åŠ›ï¼Œå¹¶å¢åŠ æ¶ˆæ¯æˆåŠŸå‘é€çš„æ¦‚ç‡ã€‚
é€šè¿‡è®¾ç½® Producer acks æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿ç”Ÿäº§è€…æ”¶åˆ° Kafka æœåŠ¡å™¨çš„ç¡®è®¤ï¼ŒçŸ¥æ™“æ¶ˆæ¯æ˜¯å¦è¢«æˆåŠŸæäº¤ã€‚
 acks=0ï¼š ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯åä¸ä¼šç­‰å¾…ä»»ä½•ç¡®è®¤ï¼Œç›´æ¥å°†æ¶ˆæ¯è§†ä¸ºå‘é€æˆåŠŸã€‚è¿™ç§è®¾ç½®ä¸‹ï¼Œå¯èƒ½ä¼šå‡ºç°æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µï¼Œå› ä¸ºç”Ÿäº§è€…ä¸ä¼šç­‰å¾…æœåŠ¡å™¨çš„ä»»ä½•ç¡®è®¤å³è®¤ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸã€‚ acks=1ï¼š ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯åä¼šç­‰å¾… Leader Broker çš„ç¡®è®¤ï¼Œç¡®è®¤åå³è§†ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸã€‚è¿™ç§è®¾ç½®ä¸‹ï¼Œæ¶ˆæ¯çš„å¯é æ€§å¾—åˆ°ä¸€å®šç¨‹åº¦çš„ä¿è¯ï¼Œä½†ä»æœ‰å¯èƒ½å‘ç”Ÿ Leader Broker å®•æœºå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µã€‚ acks=allï¼š ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯åä¼šç­‰å¾… Leader Broker å’Œæ‰€æœ‰å‰¯æœ¬çš„ç¡®è®¤ï¼Œç¡®è®¤åæ‰è§†ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸã€‚è¿™ç§è®¾ç½®ä¸‹ï¼Œæ¶ˆæ¯çš„å¯é æ€§å’Œä¸€è‡´æ€§å¾—åˆ°æœ€é«˜çº§åˆ«çš„ä¿è¯ï¼Œä½†åŒæ—¶ä¹Ÿä¼šå¢åŠ ç½‘ç»œå»¶è¿Ÿå’Œèµ„æºæ¶ˆè€—ã€‚  import org.apache.kafka.clients.producer.*; import org.apache.kafka.common.serialization.StringSerializer; import java.util.Properties; public class KafkaProducerExample { private static final String TOPIC_NAME = &#34;my-topic&#34;; private static final String BOOTSTRAP_SERVERS = &#34;localhost:9092&#34;; public static void main(String[] args) { Properties props = new Properties(); props.">
<meta name=author content="zhangyw">
<link rel=canonical href=https://blog.zhangyingwei.com/posts/2024m4d2h10m23s15/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.64f3692c16cf6e6d25580c5ffff1fefc9804abc450b958d1b31de5d6a14c5b8e.css integrity="sha256-ZPNpLBbPbm0lWAxf//H+/JgEq8RQuVjRsx3l1qFMW44=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.zhangyingwei.com/images/favicon64.ico>
<link rel=icon type=image/png sizes=16x16 href=https://blog.zhangyingwei.com/images/favicon16.ico>
<link rel=icon type=image/png sizes=32x32 href=https://blog.zhangyingwei.com/images/favicon32.ico>
<link rel=apple-touch-icon href=https://blog.zhangyingwei.com/apple-touch-icon.png>
<link rel=mask-icon href=https://blog.zhangyingwei.com/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><link href=https://hushuo.zhangyingwei.com/NotoSerifSC.css rel=stylesheet>
<link href=https://hushuo.zhangyingwei.com/JetBrainsMono.css rel=stylesheet>
<script>var _hmt=_hmt||[];(function(){var a=document.createElement("script"),b;a.src="https://hm.baidu.com/hm.js?ba380df4e327c711daf3b841b4089ce4",b=document.getElementsByTagName("script")[0],b.parentNode.insertBefore(a,b)})()</script>
<script async src=https://umami.zhangyingwei.com/script.js data-website-id=cb41ccbd-6ee9-4587-9c03-d872f2d10472></script><meta property="og:title" content="æ¢ç´¢ Kafka æ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ">
<meta property="og:description" content="åœ¨æ„å»ºåŸºäº Kafka çš„æ¶ˆæ¯å¤„ç†ç³»ç»Ÿä¸­ï¼Œæ¶ˆæ¯ä¸¢å¤±æ˜¯ä¸€ä¸ªéœ€è¦æ·±å…¥ç ”ç©¶çš„é‡è¦é—®é¢˜ã€‚å¼ºå¤§çš„ç³»ç»Ÿä¸ä»…ä¾èµ–äºå…¶åŠŸèƒ½ï¼Œè€Œä¸”ä¾èµ–äºå…¶å¯é æ€§ã€‚å› æ­¤ï¼Œç†è§£æ¶ˆæ¯ä¸¢å¤±çš„åŸå› ï¼Œå¹¶é‡‡å–å¿…è¦çš„æªæ–½ç¡®ä¿æ¶ˆæ¯çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ï¼Œæ˜¯æ„å»ºé«˜æ•ˆå¯é æ¶ˆæ¯ç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚æœ¬æ–‡å°†è¯¦ç»†åˆ†æ Kafka æ¶ˆæ¯ä¸¢å¤±çš„ä¸»è¦åŸå› ï¼Œå¹¶æä¾›ä¸€ç³»åˆ—ç­–ç•¥æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚
æ¶ˆæ¯ä¸¢å¤±çš„åŸå›   ç”Ÿäº§è€…ç«¯é—®é¢˜ï¼š åœ¨ Kafka ç³»ç»Ÿä¸­ï¼Œç”Ÿäº§è€…è´Ÿè´£å‘é€æ¶ˆæ¯ã€‚ç„¶è€Œï¼Œç”±äºç½‘ç»œæ•…éšœæˆ–å…¶ä»–æœªçŸ¥é—®é¢˜ï¼Œç”Ÿäº§è€…å¯èƒ½æ— æ³•æˆåŠŸå‘é€æ¶ˆæ¯åˆ° Kafka æœåŠ¡å™¨ã€‚ Kafka æœåŠ¡ç«¯é—®é¢˜ï¼š Kafka æœåŠ¡å™¨å¯èƒ½ä¼šå› ä¸ºç¡¬ä»¶æ•…éšœã€ç£ç›˜æ»¡æˆ–å…¶ä»–å¼‚å¸¸æƒ…å†µå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ã€‚ æ¶ˆè´¹è€…ç«¯é—®é¢˜ï¼š æ¶ˆè´¹è€…è´Ÿè´£å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯ã€‚ä½†æ˜¯ï¼Œæ¶ˆè´¹è€…åœ¨å¤„ç†æ¶ˆæ¯æ—¶å¯èƒ½ä¼šå‡ºç°é”™è¯¯æˆ–å´©æºƒï¼Œå¯¼è‡´æ¶ˆæ¯æœªè¢«æ­£ç¡®å¤„ç†ã€‚  è§£å†³æ–¹æ¡ˆä¸æªæ–½ ç”Ÿäº§è€…ç«¯ç›¸å…³æ–¹æ¡ˆä¸æªæ–½  å‘é€æ¶ˆæ¯å¤„ç†å›è°ƒæ–¹æ³•  ç”±äºæ¶ˆæ¯çš„å¸¸è§„å‘é€é‡‡ç”¨çš„å¼‚æ­¥æ–¹å¼ï¼Œæ‰€ä»¥é€šå¸¸ä¼šå¿½ç•¥æ‰å›è°ƒå¤„ç†ï¼Œä¸ºäº†ä¿è¯æ¶ˆæ¯çš„å‘é€è´¨é‡ï¼Œä¸€å®šéœ€è¦å¯¹å›è°ƒä¿¡æ¯è¿›è¡Œå¤„ç†æˆ–è€…æ”¹ä¸ºåŒæ­¥å‘é€ã€‚
producer.send(newÂ ProducerRecord<>(topic,Â messageKey,Â messageStr), newÂ CallBack({...}); è®¾ç½®æœ‰æ•ˆçš„é‡è¯•ç­–ç•¥ä»¥åŠ acks é…ç½®  æˆ‘ä»¬å¯ä»¥åœ¨ç”Ÿäº§è€…ç«¯è®¾ç½®ä¸€ä¸ªæœ‰æ•ˆçš„é‡è¯•ç­–ç•¥ï¼Œä¿è¯æ¶ˆæ¯æˆåŠŸå‘é€ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æŒ‡æ•°é€€é¿ç®—æ³•è¿›è¡Œé‡è¯•ã€‚è¿™ç§ç®—æ³•ä¼šåœ¨æ¯æ¬¡é‡è¯•å¤±è´¥åç­‰å¾…æ›´é•¿çš„æ—¶é—´ï¼Œä»è€Œå‡è½»æœåŠ¡å™¨çš„å‹åŠ›ï¼Œå¹¶å¢åŠ æ¶ˆæ¯æˆåŠŸå‘é€çš„æ¦‚ç‡ã€‚
é€šè¿‡è®¾ç½® Producer acks æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿ç”Ÿäº§è€…æ”¶åˆ° Kafka æœåŠ¡å™¨çš„ç¡®è®¤ï¼ŒçŸ¥æ™“æ¶ˆæ¯æ˜¯å¦è¢«æˆåŠŸæäº¤ã€‚
 acks=0ï¼š ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯åä¸ä¼šç­‰å¾…ä»»ä½•ç¡®è®¤ï¼Œç›´æ¥å°†æ¶ˆæ¯è§†ä¸ºå‘é€æˆåŠŸã€‚è¿™ç§è®¾ç½®ä¸‹ï¼Œå¯èƒ½ä¼šå‡ºç°æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µï¼Œå› ä¸ºç”Ÿäº§è€…ä¸ä¼šç­‰å¾…æœåŠ¡å™¨çš„ä»»ä½•ç¡®è®¤å³è®¤ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸã€‚ acks=1ï¼š ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯åä¼šç­‰å¾… Leader Broker çš„ç¡®è®¤ï¼Œç¡®è®¤åå³è§†ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸã€‚è¿™ç§è®¾ç½®ä¸‹ï¼Œæ¶ˆæ¯çš„å¯é æ€§å¾—åˆ°ä¸€å®šç¨‹åº¦çš„ä¿è¯ï¼Œä½†ä»æœ‰å¯èƒ½å‘ç”Ÿ Leader Broker å®•æœºå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µã€‚ acks=allï¼š ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯åä¼šç­‰å¾… Leader Broker å’Œæ‰€æœ‰å‰¯æœ¬çš„ç¡®è®¤ï¼Œç¡®è®¤åæ‰è§†ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸã€‚è¿™ç§è®¾ç½®ä¸‹ï¼Œæ¶ˆæ¯çš„å¯é æ€§å’Œä¸€è‡´æ€§å¾—åˆ°æœ€é«˜çº§åˆ«çš„ä¿è¯ï¼Œä½†åŒæ—¶ä¹Ÿä¼šå¢åŠ ç½‘ç»œå»¶è¿Ÿå’Œèµ„æºæ¶ˆè€—ã€‚  import org.apache.kafka.clients.producer.*; import org.apache.kafka.common.serialization.StringSerializer; import java.util.Properties; public class KafkaProducerExample { private static final String TOPIC_NAME = &#34;my-topic&#34;; private static final String BOOTSTRAP_SERVERS = &#34;localhost:9092&#34;; public static void main(String[] args) { Properties props = new Properties(); props.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.zhangyingwei.com/posts/2024m4d2h10m23s15/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2024-01-02T10:23:15+08:00">
<meta property="article:modified_time" content="2024-01-02T10:23:15+08:00"><meta property="og:site_name" content="èƒ¡è¯´">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.zhangyingwei.com/posts/"},{"@type":"ListItem","position":2,"name":"æ¢ç´¢ Kafka æ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ","item":"https://blog.zhangyingwei.com/posts/2024m4d2h10m23s15/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"æ¢ç´¢ Kafka æ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ","name":"æ¢ç´¢ Kafka æ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ","description":"åœ¨æ„å»ºåŸºäº Kafka çš„æ¶ˆæ¯å¤„ç†ç³»ç»Ÿä¸­ï¼Œæ¶ˆæ¯ä¸¢å¤±æ˜¯ä¸€ä¸ªéœ€è¦æ·±å…¥ç ”ç©¶çš„é‡è¦é—®é¢˜ã€‚å¼ºå¤§çš„ç³»ç»Ÿä¸ä»…ä¾èµ–äºå…¶åŠŸèƒ½ï¼Œè€Œä¸”ä¾èµ–äºå…¶å¯é æ€§ã€‚å› æ­¤ï¼Œç†è§£æ¶ˆæ¯ä¸¢å¤±çš„åŸå› ï¼Œå¹¶é‡‡å–å¿…è¦çš„æªæ–½ç¡®ä¿æ¶ˆæ¯çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ï¼Œæ˜¯æ„å»ºé«˜æ•ˆå¯é æ¶ˆæ¯ç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚æœ¬æ–‡å°†è¯¦ç»†åˆ†æ Kafka æ¶ˆæ¯ä¸¢å¤±çš„ä¸»è¦åŸå› ï¼Œå¹¶æä¾›ä¸€ç³»åˆ—ç­–ç•¥æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\næ¶ˆæ¯ä¸¢å¤±çš„åŸå›   ç”Ÿäº§è€…ç«¯é—®é¢˜ï¼š åœ¨ Kafka ç³»ç»Ÿä¸­ï¼Œç”Ÿäº§è€…è´Ÿè´£å‘é€æ¶ˆæ¯ã€‚ç„¶è€Œï¼Œç”±äºç½‘ç»œæ•…éšœæˆ–å…¶ä»–æœªçŸ¥é—®é¢˜ï¼Œç”Ÿäº§è€…å¯èƒ½æ— æ³•æˆåŠŸå‘é€æ¶ˆæ¯åˆ° Kafka æœåŠ¡å™¨ã€‚ Kafka æœåŠ¡ç«¯é—®é¢˜ï¼š Kafka æœåŠ¡å™¨å¯èƒ½ä¼šå› ä¸ºç¡¬ä»¶æ•…éšœã€ç£ç›˜æ»¡æˆ–å…¶ä»–å¼‚å¸¸æƒ…å†µå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ã€‚ æ¶ˆè´¹è€…ç«¯é—®é¢˜ï¼š æ¶ˆè´¹è€…è´Ÿè´£å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯ã€‚ä½†æ˜¯ï¼Œæ¶ˆè´¹è€…åœ¨å¤„ç†æ¶ˆæ¯æ—¶å¯èƒ½ä¼šå‡ºç°é”™è¯¯æˆ–å´©æºƒï¼Œå¯¼è‡´æ¶ˆæ¯æœªè¢«æ­£ç¡®å¤„ç†ã€‚  è§£å†³æ–¹æ¡ˆä¸æªæ–½ ç”Ÿäº§è€…ç«¯ç›¸å…³æ–¹æ¡ˆä¸æªæ–½  å‘é€æ¶ˆæ¯å¤„ç†å›è°ƒæ–¹æ³•  ç”±äºæ¶ˆæ¯çš„å¸¸è§„å‘é€é‡‡ç”¨çš„å¼‚æ­¥æ–¹å¼ï¼Œæ‰€ä»¥é€šå¸¸ä¼šå¿½ç•¥æ‰å›è°ƒå¤„ç†ï¼Œä¸ºäº†ä¿è¯æ¶ˆæ¯çš„å‘é€è´¨é‡ï¼Œä¸€å®šéœ€è¦å¯¹å›è°ƒä¿¡æ¯è¿›è¡Œå¤„ç†æˆ–è€…æ”¹ä¸ºåŒæ­¥å‘é€ã€‚\nproducer.send(newÂ ProducerRecord\u0026lt;\u0026gt;(topic,Â messageKey,Â messageStr), newÂ CallBack({...}); è®¾ç½®æœ‰æ•ˆçš„é‡è¯•ç­–ç•¥ä»¥åŠ acks é…ç½®  æˆ‘ä»¬å¯ä»¥åœ¨ç”Ÿäº§è€…ç«¯è®¾ç½®ä¸€ä¸ªæœ‰æ•ˆçš„é‡è¯•ç­–ç•¥ï¼Œä¿è¯æ¶ˆæ¯æˆåŠŸå‘é€ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æŒ‡æ•°é€€é¿ç®—æ³•è¿›è¡Œé‡è¯•ã€‚è¿™ç§ç®—æ³•ä¼šåœ¨æ¯æ¬¡é‡è¯•å¤±è´¥åç­‰å¾…æ›´é•¿çš„æ—¶é—´ï¼Œä»è€Œå‡è½»æœåŠ¡å™¨çš„å‹åŠ›ï¼Œå¹¶å¢åŠ æ¶ˆæ¯æˆåŠŸå‘é€çš„æ¦‚ç‡ã€‚\né€šè¿‡è®¾ç½® Producer acks æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿ç”Ÿäº§è€…æ”¶åˆ° Kafka æœåŠ¡å™¨çš„ç¡®è®¤ï¼ŒçŸ¥æ™“æ¶ˆæ¯æ˜¯å¦è¢«æˆåŠŸæäº¤ã€‚\n acks=0ï¼š ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯åä¸ä¼šç­‰å¾…ä»»ä½•ç¡®è®¤ï¼Œç›´æ¥å°†æ¶ˆæ¯è§†ä¸ºå‘é€æˆåŠŸã€‚è¿™ç§è®¾ç½®ä¸‹ï¼Œå¯èƒ½ä¼šå‡ºç°æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µï¼Œå› ä¸ºç”Ÿäº§è€…ä¸ä¼šç­‰å¾…æœåŠ¡å™¨çš„ä»»ä½•ç¡®è®¤å³è®¤ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸã€‚ acks=1ï¼š ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯åä¼šç­‰å¾… Leader Broker çš„ç¡®è®¤ï¼Œç¡®è®¤åå³è§†ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸã€‚è¿™ç§è®¾ç½®ä¸‹ï¼Œæ¶ˆæ¯çš„å¯é æ€§å¾—åˆ°ä¸€å®šç¨‹åº¦çš„ä¿è¯ï¼Œä½†ä»æœ‰å¯èƒ½å‘ç”Ÿ Leader Broker å®•æœºå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µã€‚ acks=allï¼š ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯åä¼šç­‰å¾… Leader Broker å’Œæ‰€æœ‰å‰¯æœ¬çš„ç¡®è®¤ï¼Œç¡®è®¤åæ‰è§†ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸã€‚è¿™ç§è®¾ç½®ä¸‹ï¼Œæ¶ˆæ¯çš„å¯é æ€§å’Œä¸€è‡´æ€§å¾—åˆ°æœ€é«˜çº§åˆ«çš„ä¿è¯ï¼Œä½†åŒæ—¶ä¹Ÿä¼šå¢åŠ ç½‘ç»œå»¶è¿Ÿå’Œèµ„æºæ¶ˆè€—ã€‚  import org.apache.kafka.clients.producer.*; import org.apache.kafka.common.serialization.StringSerializer; import java.util.Properties; public class KafkaProducerExample { private static final String TOPIC_NAME = \u0026#34;my-topic\u0026#34;; private static final String BOOTSTRAP_SERVERS = \u0026#34;localhost:9092\u0026#34;; public static void main(String[] args) { Properties props = new Properties(); props.","keywords":["èƒ¡è¯´","é™æ€åšå®¢","å¼ è‹±ä¼Ÿ","å¼ è‹±ä¼Ÿçš„ä¸ªäººåšå®¢","SpringBoot","Java","Kafka"],"articleBody":"åœ¨æ„å»ºåŸºäº Kafka çš„æ¶ˆæ¯å¤„ç†ç³»ç»Ÿä¸­ï¼Œæ¶ˆæ¯ä¸¢å¤±æ˜¯ä¸€ä¸ªéœ€è¦æ·±å…¥ç ”ç©¶çš„é‡è¦é—®é¢˜ã€‚å¼ºå¤§çš„ç³»ç»Ÿä¸ä»…ä¾èµ–äºå…¶åŠŸèƒ½ï¼Œè€Œä¸”ä¾èµ–äºå…¶å¯é æ€§ã€‚å› æ­¤ï¼Œç†è§£æ¶ˆæ¯ä¸¢å¤±çš„åŸå› ï¼Œå¹¶é‡‡å–å¿…è¦çš„æªæ–½ç¡®ä¿æ¶ˆæ¯çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ï¼Œæ˜¯æ„å»ºé«˜æ•ˆå¯é æ¶ˆæ¯ç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚æœ¬æ–‡å°†è¯¦ç»†åˆ†æ Kafka æ¶ˆæ¯ä¸¢å¤±çš„ä¸»è¦åŸå› ï¼Œå¹¶æä¾›ä¸€ç³»åˆ—ç­–ç•¥æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\næ¶ˆæ¯ä¸¢å¤±çš„åŸå›   ç”Ÿäº§è€…ç«¯é—®é¢˜ï¼š åœ¨ Kafka ç³»ç»Ÿä¸­ï¼Œç”Ÿäº§è€…è´Ÿè´£å‘é€æ¶ˆæ¯ã€‚ç„¶è€Œï¼Œç”±äºç½‘ç»œæ•…éšœæˆ–å…¶ä»–æœªçŸ¥é—®é¢˜ï¼Œç”Ÿäº§è€…å¯èƒ½æ— æ³•æˆåŠŸå‘é€æ¶ˆæ¯åˆ° Kafka æœåŠ¡å™¨ã€‚ Kafka æœåŠ¡ç«¯é—®é¢˜ï¼š Kafka æœåŠ¡å™¨å¯èƒ½ä¼šå› ä¸ºç¡¬ä»¶æ•…éšœã€ç£ç›˜æ»¡æˆ–å…¶ä»–å¼‚å¸¸æƒ…å†µå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ã€‚ æ¶ˆè´¹è€…ç«¯é—®é¢˜ï¼š æ¶ˆè´¹è€…è´Ÿè´£å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯ã€‚ä½†æ˜¯ï¼Œæ¶ˆè´¹è€…åœ¨å¤„ç†æ¶ˆæ¯æ—¶å¯èƒ½ä¼šå‡ºç°é”™è¯¯æˆ–å´©æºƒï¼Œå¯¼è‡´æ¶ˆæ¯æœªè¢«æ­£ç¡®å¤„ç†ã€‚  è§£å†³æ–¹æ¡ˆä¸æªæ–½ ç”Ÿäº§è€…ç«¯ç›¸å…³æ–¹æ¡ˆä¸æªæ–½  å‘é€æ¶ˆæ¯å¤„ç†å›è°ƒæ–¹æ³•  ç”±äºæ¶ˆæ¯çš„å¸¸è§„å‘é€é‡‡ç”¨çš„å¼‚æ­¥æ–¹å¼ï¼Œæ‰€ä»¥é€šå¸¸ä¼šå¿½ç•¥æ‰å›è°ƒå¤„ç†ï¼Œä¸ºäº†ä¿è¯æ¶ˆæ¯çš„å‘é€è´¨é‡ï¼Œä¸€å®šéœ€è¦å¯¹å›è°ƒä¿¡æ¯è¿›è¡Œå¤„ç†æˆ–è€…æ”¹ä¸ºåŒæ­¥å‘é€ã€‚\nproducer.send(newÂ ProducerRecord(topic,Â messageKey,Â messageStr), newÂ CallBack({...}); è®¾ç½®æœ‰æ•ˆçš„é‡è¯•ç­–ç•¥ä»¥åŠ acks é…ç½®  æˆ‘ä»¬å¯ä»¥åœ¨ç”Ÿäº§è€…ç«¯è®¾ç½®ä¸€ä¸ªæœ‰æ•ˆçš„é‡è¯•ç­–ç•¥ï¼Œä¿è¯æ¶ˆæ¯æˆåŠŸå‘é€ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æŒ‡æ•°é€€é¿ç®—æ³•è¿›è¡Œé‡è¯•ã€‚è¿™ç§ç®—æ³•ä¼šåœ¨æ¯æ¬¡é‡è¯•å¤±è´¥åç­‰å¾…æ›´é•¿çš„æ—¶é—´ï¼Œä»è€Œå‡è½»æœåŠ¡å™¨çš„å‹åŠ›ï¼Œå¹¶å¢åŠ æ¶ˆæ¯æˆåŠŸå‘é€çš„æ¦‚ç‡ã€‚\né€šè¿‡è®¾ç½® Producer acks æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿ç”Ÿäº§è€…æ”¶åˆ° Kafka æœåŠ¡å™¨çš„ç¡®è®¤ï¼ŒçŸ¥æ™“æ¶ˆæ¯æ˜¯å¦è¢«æˆåŠŸæäº¤ã€‚\n acks=0ï¼š ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯åä¸ä¼šç­‰å¾…ä»»ä½•ç¡®è®¤ï¼Œç›´æ¥å°†æ¶ˆæ¯è§†ä¸ºå‘é€æˆåŠŸã€‚è¿™ç§è®¾ç½®ä¸‹ï¼Œå¯èƒ½ä¼šå‡ºç°æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µï¼Œå› ä¸ºç”Ÿäº§è€…ä¸ä¼šç­‰å¾…æœåŠ¡å™¨çš„ä»»ä½•ç¡®è®¤å³è®¤ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸã€‚ acks=1ï¼š ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯åä¼šç­‰å¾… Leader Broker çš„ç¡®è®¤ï¼Œç¡®è®¤åå³è§†ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸã€‚è¿™ç§è®¾ç½®ä¸‹ï¼Œæ¶ˆæ¯çš„å¯é æ€§å¾—åˆ°ä¸€å®šç¨‹åº¦çš„ä¿è¯ï¼Œä½†ä»æœ‰å¯èƒ½å‘ç”Ÿ Leader Broker å®•æœºå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µã€‚ acks=allï¼š ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯åä¼šç­‰å¾… Leader Broker å’Œæ‰€æœ‰å‰¯æœ¬çš„ç¡®è®¤ï¼Œç¡®è®¤åæ‰è§†ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸã€‚è¿™ç§è®¾ç½®ä¸‹ï¼Œæ¶ˆæ¯çš„å¯é æ€§å’Œä¸€è‡´æ€§å¾—åˆ°æœ€é«˜çº§åˆ«çš„ä¿è¯ï¼Œä½†åŒæ—¶ä¹Ÿä¼šå¢åŠ ç½‘ç»œå»¶è¿Ÿå’Œèµ„æºæ¶ˆè€—ã€‚  import org.apache.kafka.clients.producer.*; import org.apache.kafka.common.serialization.StringSerializer; import java.util.Properties; public class KafkaProducerExample { private static final String TOPIC_NAME = \"my-topic\"; private static final String BOOTSTRAP_SERVERS = \"localhost:9092\"; public static void main(String[] args) { Properties props = new Properties(); props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, BOOTSTRAP_SERVERS); props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName()); props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName()); // è®¾ç½®é‡è¯•æ¬¡æ•°ä¸º3æ¬¡  props.put(ProducerConfig.RETRIES_CONFIG, 3); // æŒ‡æ•°é€€é¿ç®—æ³•å‚æ•° \t// åˆå§‹é‡è¯•é—´éš”ä¸º1ç§’ \tprops.put(ProducerConfig.RETRY_BACKOFF_MS_CONFIG, 1000); // æœ€å¤§é‡è¯•é—´éš”ä¸º30ç§’ \tprops.put(ProducerConfig.RETRY_BACKOFF_MAX_MS_CONFIG, 30000); // è®¾ç½® acks é…ç½®ä¸º all \tproperties.setProperty(ProducerConfig.ACKS_CONFIG, \"all\"); KafkaProducerString, String producer = new KafkaProducer(props); // ... å…¶ä»–ä¸šåŠ¡é€»è¾‘  } } å¯ç”¨ Kafka æ—¥å¿—å‹ç¼©  Kafka æä¾›äº†æ—¥å¿—å‹ç¼©åŠŸèƒ½ï¼Œè¿™å¯ä»¥å‡å°‘ç£ç›˜ç©ºé—´çš„ä½¿ç”¨ï¼Œå¹¶æé«˜æ¶ˆæ¯å­˜å‚¨çš„å¯é æ€§ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å‡å°‘å› ç£ç›˜æ»¡å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±é£é™©ã€‚\nimport org.apache.kafka.clients.producer.*; import org.apache.kafka.common.serialization.StringSerializer; import java.util.Properties; public class KafkaProducerExample { private static final String TOPIC_NAME = \"my-topic\"; private static final String BOOTSTRAP_SERVERS = \"localhost:9092\"; public static void main(String[] args) { Properties props = new Properties(); props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, BOOTSTRAP_SERVERS); props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName()); props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName()); // å…¶ä»–è®¾ç½®...  // å¯ç”¨æ—¥å¿—å‹ç¼©ï¼Œä½¿ç”¨gzipå‹ç¼©ç®—æ³•  props.put(ProducerConfig.COMPRESSION_TYPE_CONFIG, \"gzip\"); KafkaProducerString, String producer = new KafkaProducer(props); // ... å…¶ä»–ä¸šåŠ¡é€»è¾‘  } } Kafka æœåŠ¡ç«¯ç›¸å…³æ–¹æ¡ˆä¸æªæ–½ åœ¨ Kafka æœåŠ¡ç«¯ï¼Œè¦ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ï¼Œéœ€è¦ä»å‡ æ–¹é¢è€ƒè™‘\nåˆç†çš„é…ç½®\n æ ¹æ®æ•°æ®é‡çº§ï¼Œé…ç½®åˆç†çš„ partition æ•°é‡ï¼Œæé«˜ååé‡ï¼Œé¿å…æ€§èƒ½ç“¶é¢ˆå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±  é«˜å¯ç”¨ï¼š\n å¤šå‰¯æœ¬é…ç½®ï¼š åœ¨ Kafka é›†ç¾¤ä¸­è®¾ç½®å¤šä¸ªå‰¯æœ¬ï¼Œä»¥ç¡®ä¿å³ä½¿æŸäº› Broker å‘ç”Ÿæ•…éšœï¼Œä»ç„¶èƒ½å¤Ÿä¿è¯æ¶ˆæ¯çš„å¯ç”¨æ€§å’Œä¸€è‡´æ€§ ISRï¼ˆIn-Sync Replicasï¼‰æœºåˆ¶ï¼š ä½¿ç”¨ ISR æœºåˆ¶æ¥ç¡®ä¿æ‰€æœ‰å‰¯æœ¬ä¹‹é—´çš„åŒæ­¥æ€§ï¼Œåªæœ‰åœ¨æ‰€æœ‰ ISR ä¸­çš„å‰¯æœ¬éƒ½åŒæ­¥æˆåŠŸåæ‰è®¤ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸ Controller é€‰ä¸¾ï¼š é…ç½® Controller é€‰ä¸¾æœºåˆ¶ï¼Œç¡®ä¿ Kafka é›†ç¾¤ä¸­çš„ Controller èƒ½å¤ŸåŠæ—¶å¤„ç† Broker çš„æ•…éšœå’Œåˆ‡æ¢  æ•°æ®æŒä¹…åŒ–å’Œæ—¥å¿—ç®¡ç†ï¼š\n æ•°æ®æŒä¹…åŒ–ç­–ç•¥ï¼š é…ç½®åˆé€‚çš„æ•°æ®æŒä¹…åŒ–ç­–ç•¥ï¼Œä¾‹å¦‚ä½¿ç”¨æŒä¹…åŒ–æ—¥å¿—æ¥å­˜å‚¨æ¶ˆæ¯ï¼Œä¿è¯æ¶ˆæ¯ä¸ä¼šå› ä¸ºæœåŠ¡é‡å¯æˆ–å¼‚å¸¸å¯¼è‡´ä¸¢å¤±ã€‚ æ—¥å¿—ç®¡ç†å’Œæ¸…ç†ï¼š å®šæœŸæ¸…ç†è¿‡æœŸçš„æ—¥å¿—æ®µï¼ˆlog segmentï¼‰ï¼Œé¿å…æ—¥å¿—æ–‡ä»¶è¿‡å¤§å¯¼è‡´ç£ç›˜ç©ºé—´ä¸è¶³ï¼ŒåŒæ—¶ç¡®ä¿æ¶ˆæ¯çš„åŠæ—¶æ¸…ç†å’Œå½’æ¡£ã€‚  ç›‘æ§å’Œæ•…éšœæ¢å¤ï¼š\n ç›‘æ§å’ŒæŠ¥è­¦ï¼š é…ç½®ç›‘æ§ç³»ç»Ÿï¼Œå®æ—¶ç›‘æµ‹ Kafka é›†ç¾¤çš„è¿è¡ŒçŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡ï¼Œå¹¶è®¾ç½®æŠ¥è­¦æœºåˆ¶ï¼Œåœ¨å‡ºç°å¼‚å¸¸æˆ–æ€§èƒ½ä¸‹é™æ—¶åŠæ—¶å‘ç°å¹¶å¤„ç†ã€‚ æ•…éšœè‡ªæ„ˆï¼š é…ç½®è‡ªåŠ¨æ•…éšœæ¢å¤æœºåˆ¶ï¼Œä¾‹å¦‚ä½¿ç”¨ Kafka çš„ Controller è‡ªåŠ¨è¿›è¡Œ Broker çš„æ•…éšœæ£€æµ‹å’Œåˆ‡æ¢ï¼Œç¡®ä¿é›†ç¾¤åœ¨å‘ç”Ÿæ•…éšœæ—¶èƒ½å¤Ÿå¿«é€Ÿæ¢å¤ã€‚  æ¶ˆè´¹è€…ç«¯è§£å†³æ–¹æ¡ˆä¸æªæ–½ æ‰‹åŠ¨ç»´æŠ¤ offset\n å°† enable.auto.commit è®¾ç½®ä¸º falseï¼Œå¹¶ä¸”åœ¨æ¶ˆè´¹è€…ç«¯æ‰‹åŠ¨æäº¤åç§»é‡ã€‚ ä½¿ç”¨è¾ƒå°çš„ auto.commit.interval.ms å€¼ï¼Œä»¥å‡å°‘è‡ªåŠ¨æäº¤åç§»é‡çš„æ—¶é—´é—´éš”ï¼Œæé«˜åç§»é‡çš„æäº¤é¢‘ç‡ã€‚  import org.apache.kafka.clients.consumer.*; import org.apache.kafka.common.TopicPartition; import redis.clients.jedis.Jedis; import java.time.Duration; import java.util.Collections; import java.util.Properties; public class KafkaConsumerWithRedisOffsetOnStartup { public static void main(String[] args) { String kafkaBootstrapServers = \"kafka-broker1:9092,kafka-broker2:9092\"; String kafkaTopic = \"test-topic\"; String groupId = \"test-consumer-group\"; String redisHost = \"localhost\"; int redisPort = 6379; // Kafka Consumer é…ç½®  Properties props = new Properties(); props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, kafkaBootstrapServers); props.put(ConsumerConfig.GROUP_ID_CONFIG, groupId); props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, \"org.apache.kafka.common.serialization.StringDeserializer\"); props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, \"org.apache.kafka.common.serialization.StringDeserializer\"); props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, \"false\"); // å…³é—­è‡ªåŠ¨æäº¤åç§»é‡  props.put(ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG, \"100\"); // è®¾ç½®è‡ªåŠ¨æäº¤åç§»é‡çš„æ—¶é—´é—´éš”ä¸º 100 æ¯«ç§’  KafkaConsumerString, String consumer = new KafkaConsumer(props); // Redis è¿æ¥  Jedis jedis = new Jedis(redisHost, redisPort); try { // ä» Redis ä¸­è·å–åç§»é‡  MapTopicPartition, Long offsets = getOffsetsFromRedis(jedis, kafkaTopic, groupId); // è®¢é˜…ä¸»é¢˜å¹¶è®¾ç½®åç§»é‡  consumer.subscribe(Collections.singleton(kafkaTopic), new ConsumerRebalanceListener() { @Override public void onPartitionsRevoked(CollectionTopicPartition partitions) {} @Override public void onPartitionsAssigned(CollectionTopicPartition partitions) { for (TopicPartition partition : partitions) { consumer.seek(partition, offsets.getOrDefault(partition, 0L)); } } }); while (true) { ConsumerRecordsString, String records = consumer.poll(Duration.ofMillis(100)); for (ConsumerRecordString, String record : records) { System.out.println(\"Received message: \" + record.value()); // å¤„ç†æ¶ˆæ¯...  // æ‰‹åŠ¨æäº¤åç§»é‡åˆ° Redis  saveOffsetInRedis(jedis, record.topic(), record.partition(), record.offset()); // æ‰‹åŠ¨æäº¤åç§»é‡åˆ° Kafka  consumer.commitSync(Collections.singletonMap(new TopicPartition(record.topic(), record.partition()), new OffsetAndMetadata(record.offset() + 1))); } } } finally { consumer.close(); jedis.close(); } } private static MapTopicPartition, Long getOffsetsFromRedis(Jedis jedis, String topic, String groupId) { MapTopicPartition, Long offsets = new HashMap(); for (String key : jedis.keys(\"offset-\" + topic + \"-*\")) { String[] parts = key.split(\"-\"); int partition = Integer.parseInt(parts[parts.length - 1]); long offset = Long.parseLong(jedis.get(key)); offsets.put(new TopicPartition(topic, partition), offset); } return offsets; } private static void saveOffsetInRedis(Jedis jedis, String topic, int partition, long offset) { String key = \"offset-\" + topic + \"-\" + partition; jedis.set(key, String.valueOf(offset)); } } æ€»ç»“ æ€»å¾—æ¥è¯´ï¼Œå…³äºæ¶ˆæ¯å¯é æ€§çš„ä¿è¯ï¼Œéœ€è¦ä»ç”Ÿäº§ç«¯ã€æœåŠ¡ç«¯ã€æ¶ˆè´¹ç«¯ä¸‰ä¸ªæ–¹é¢ç»¼åˆè€ƒè™‘ï¼Œä¸æ˜¯ä»…ä»…ä¸€ä¸ªæ–¹é¢çš„é—®é¢˜ã€‚\næ‹“å±• Kafka å®˜æ–¹å¸¸ç”¨å·¥å…·\n#Â æŸ¥çœ‹æŸä¸ªtopicçš„messageæ•°é‡ $Â ./kafka-run-class.shÂ kafka.tools.GetOffsetShellÂ --broker-listÂ localhost:9092Â --topicÂ test_topic #Â æŸ¥çœ‹consumerÂ Groupåˆ—è¡¨ $Â ./kafka-consumer-groups.shÂ --listÂ --bootstrap-serverÂ 192.168.88.108:9092 #Â æŸ¥çœ‹Â offsetÂ æ¶ˆè´¹æƒ…å†µ $Â ./kafka-consumer-groups.shÂ --bootstrap-serverÂ localhost:9092Â --groupÂ console-consumer-1152Â --describe GROUPÂ TOPICÂ PARTITIONÂ CURRENT-OFFSETÂ LOG-END-OFFSETÂ LAGÂ CONSUMER-IDÂ HOSTÂ CLIENT-ID console-consumer-1152Â test_topicÂ 0Â -Â 4Â -Â consumer-console-consumer-1152-1-2703ea2b-b62d-4cfd-8950-34e8c321b942Â /127.0.0.1Â consumer-console-consumer-1152-1 KafkaÂ æ—¥å¿—åˆ·ç›˜æœºåˆ¶\n#Â æ¨èé‡‡ç”¨é»˜è®¤å€¼ï¼Œå³ä¸é…ç½®è¯¥é…ç½®ï¼Œäº¤ç”±æ“ä½œç³»ç»Ÿè‡ªè¡Œå†³å®šä½•æ—¶è½ç›˜ï¼Œä»¥æå‡æ€§èƒ½ã€‚ #Â é’ˆå¯¹ broker é…ç½®ï¼š log.flush.interval.messages=10000Â #Â æ—¥å¿—è½ç›˜æ¶ˆæ¯æ¡æ•°é—´éš”ï¼Œå³æ¯æ¥æ”¶åˆ°ä¸€å®šæ¡æ•°æ¶ˆæ¯ï¼Œå³è¿›è¡Œlogè½ç›˜ã€‚ log.flush.interval.ms=1000Â #Â æ—¥å¿—è½ç›˜æ—¶é—´é—´éš”ï¼Œå•ä½msï¼Œå³æ¯éš”ä¸€å®šæ—¶é—´ï¼Œå³è¿›è¡Œlogè½ç›˜ã€‚ #Â é’ˆå¯¹ topic é…ç½®ï¼š flush.messages.flush.ms=1000Â #Â topicä¸‹æ¯1såˆ·ç›˜ flush.messages=1Â #Â topicä¸‹æ¯ä¸ªæ¶ˆæ¯éƒ½è½ç›˜ #Â æŸ¥çœ‹Â LinuxÂ åå°çº¿ç¨‹æ‰§è¡Œé…ç½® $Â sysctlÂ -aÂ |Â grepÂ dirty vm.dirty_background_bytesÂ =Â 0 vm.dirty_background_ratioÂ =Â 10Â #Â è¡¨ç¤ºå½“è„é¡µå æ€»å†…å­˜çš„çš„ç™¾åˆ†æ¯”è¶…è¿‡è¿™ä¸ªå€¼æ—¶ï¼Œåå°çº¿ç¨‹å¼€å§‹åˆ·æ–°è„é¡µã€‚ vm.dirty_bytesÂ =Â 0 vm.dirty_expire_centisecsÂ =Â 3000Â #Â è¡¨ç¤ºè„æ•°æ®å¤šä¹…ä¼šè¢«åˆ·æ–°åˆ°ç£ç›˜ä¸Šï¼ˆ30ç§’ï¼‰ã€‚ vm.dirty_ratioÂ =Â 20 vm.dirty_writeback_centisecsÂ =Â 500Â #Â è¡¨ç¤ºå¤šä¹…å”¤é†’ä¸€æ¬¡åˆ·æ–°è„é¡µçš„åå°çº¿ç¨‹ï¼ˆï¼•ç§’ï¼‰ã€‚ vm.dirtytime_expire_secondsÂ =Â 43200 ","wordCount":"614","inLanguage":"en","datePublished":"2024-01-02T10:23:15+08:00","dateModified":"2024-01-02T10:23:15+08:00","author":{"@type":"Person","name":"zhangyw"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.zhangyingwei.com/posts/2024m4d2h10m23s15/"},"publisher":{"@type":"Organization","name":"èƒ¡è¯´","logo":{"@type":"ImageObject","url":"https://blog.zhangyingwei.com/images/favicon64.ico"}}}</script>
</head>
<body class="font-activate bg-color mt-20" id="
    top">
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class="header font-activate sticky-element shadow-b">
<nav class=nav>
<div class=logo>
<a href=https://blog.zhangyingwei.com/ accesskey=h title="èƒ¡è¯´ (Alt + H)">èƒ¡è¯´</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://blog.zhangyingwei.com/series/ title=ç³»åˆ—æ–‡ç« >
<span>ç³»åˆ—æ–‡ç« </span>
</a>
</li>
<li>
<a href=https://blog.zhangyingwei.com/archives/ title=å½’æ¡£>
<span>å½’æ¡£</span>
</a>
</li>
<li>
<a href=https://blog.zhangyingwei.com/tags/ title=æ ‡ç­¾>
<span>æ ‡ç­¾</span>
</a>
</li>
</ul>
</nav>
</header><div style=height:20px></div>
<main class="main font-activate bg-color">
<article class="post-single item-padding">
<header class=post-header>
<h1 class=post-title>
æ¢ç´¢ Kafka æ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ
</h1>
<div class=post-info>2024/01/02
<ul id=series>
ğŸ…°ï¸
<li> <a href=https://blog.zhangyingwei.com/%20topics/java-%E7%B3%BB%E5%88%97>Java ç³»åˆ—</a> </li>
</ul>
<ul id=categories>
âœ¨
<li><a href=https://blog.zhangyingwei.com/%20categories/%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB>ç»éªŒåˆ†äº«</a> </li>
</ul>
</div>
</header>
<div class=post-content><p>åœ¨æ„å»ºåŸºäº Kafka çš„æ¶ˆæ¯å¤„ç†ç³»ç»Ÿä¸­ï¼Œæ¶ˆæ¯ä¸¢å¤±æ˜¯ä¸€ä¸ªéœ€è¦æ·±å…¥ç ”ç©¶çš„é‡è¦é—®é¢˜ã€‚å¼ºå¤§çš„ç³»ç»Ÿä¸ä»…ä¾èµ–äºå…¶åŠŸèƒ½ï¼Œè€Œä¸”ä¾èµ–äºå…¶å¯é æ€§ã€‚å› æ­¤ï¼Œç†è§£æ¶ˆæ¯ä¸¢å¤±çš„åŸå› ï¼Œå¹¶é‡‡å–å¿…è¦çš„æªæ–½ç¡®ä¿æ¶ˆæ¯çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ï¼Œæ˜¯æ„å»ºé«˜æ•ˆå¯é æ¶ˆæ¯ç³»ç»Ÿçš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚æœ¬æ–‡å°†è¯¦ç»†åˆ†æ Kafka æ¶ˆæ¯ä¸¢å¤±çš„ä¸»è¦åŸå› ï¼Œå¹¶æä¾›ä¸€ç³»åˆ—ç­–ç•¥æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<h2 id=æ¶ˆæ¯ä¸¢å¤±çš„åŸå› >æ¶ˆæ¯ä¸¢å¤±çš„åŸå› <a hidden class=anchor aria-hidden=true href=#æ¶ˆæ¯ä¸¢å¤±çš„åŸå› >#</a></h2>
<ol>
<li><strong>ç”Ÿäº§è€…ç«¯é—®é¢˜ï¼š</strong> åœ¨ Kafka ç³»ç»Ÿä¸­ï¼Œç”Ÿäº§è€…è´Ÿè´£å‘é€æ¶ˆæ¯ã€‚ç„¶è€Œï¼Œç”±äºç½‘ç»œæ•…éšœæˆ–å…¶ä»–æœªçŸ¥é—®é¢˜ï¼Œç”Ÿäº§è€…å¯èƒ½æ— æ³•æˆåŠŸå‘é€æ¶ˆæ¯åˆ° Kafka æœåŠ¡å™¨ã€‚</li>
<li><strong>Kafka æœåŠ¡ç«¯é—®é¢˜ï¼š</strong> Kafka æœåŠ¡å™¨å¯èƒ½ä¼šå› ä¸ºç¡¬ä»¶æ•…éšœã€ç£ç›˜æ»¡æˆ–å…¶ä»–å¼‚å¸¸æƒ…å†µå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ã€‚</li>
<li><strong>æ¶ˆè´¹è€…ç«¯é—®é¢˜ï¼š</strong> æ¶ˆè´¹è€…è´Ÿè´£å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯ã€‚ä½†æ˜¯ï¼Œæ¶ˆè´¹è€…åœ¨å¤„ç†æ¶ˆæ¯æ—¶å¯èƒ½ä¼šå‡ºç°é”™è¯¯æˆ–å´©æºƒï¼Œå¯¼è‡´æ¶ˆæ¯æœªè¢«æ­£ç¡®å¤„ç†ã€‚</li>
</ol>
<h2 id=è§£å†³æ–¹æ¡ˆä¸æªæ–½>è§£å†³æ–¹æ¡ˆä¸æªæ–½<a hidden class=anchor aria-hidden=true href=#è§£å†³æ–¹æ¡ˆä¸æªæ–½>#</a></h2>
<h3 id=ç”Ÿäº§è€…ç«¯ç›¸å…³æ–¹æ¡ˆä¸æªæ–½>ç”Ÿäº§è€…ç«¯ç›¸å…³æ–¹æ¡ˆä¸æªæ–½<a hidden class=anchor aria-hidden=true href=#ç”Ÿäº§è€…ç«¯ç›¸å…³æ–¹æ¡ˆä¸æªæ–½>#</a></h3>
<ol>
<li>å‘é€æ¶ˆæ¯å¤„ç†å›è°ƒæ–¹æ³•</li>
</ol>
<p>ç”±äºæ¶ˆæ¯çš„å¸¸è§„å‘é€é‡‡ç”¨çš„å¼‚æ­¥æ–¹å¼ï¼Œæ‰€ä»¥é€šå¸¸ä¼šå¿½ç•¥æ‰å›è°ƒå¤„ç†ï¼Œä¸ºäº†ä¿è¯æ¶ˆæ¯çš„å‘é€è´¨é‡ï¼Œä¸€å®šéœ€è¦å¯¹å›è°ƒä¿¡æ¯è¿›è¡Œå¤„ç†æˆ–è€…æ”¹ä¸ºåŒæ­¥å‘é€ã€‚</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>producer<span style=color:#f92672>.</span><span style=color:#a6e22e>send</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span>Â ProducerRecord<span style=color:#f92672>&lt;&gt;(</span>topic<span style=color:#f92672>,</span>Â messageKey<span style=color:#f92672>,</span>Â messageStr<span style=color:#f92672>),</span>  <span style=color:#66d9ef>new</span>Â CallBack<span style=color:#f92672>({...});</span>
</code></pre></div><ol start=2>
<li>è®¾ç½®æœ‰æ•ˆçš„é‡è¯•ç­–ç•¥ä»¥åŠ acks é…ç½®</li>
</ol>
<p>æˆ‘ä»¬å¯ä»¥åœ¨ç”Ÿäº§è€…ç«¯è®¾ç½®ä¸€ä¸ªæœ‰æ•ˆçš„é‡è¯•ç­–ç•¥ï¼Œä¿è¯æ¶ˆæ¯æˆåŠŸå‘é€ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æŒ‡æ•°é€€é¿ç®—æ³•è¿›è¡Œé‡è¯•ã€‚è¿™ç§ç®—æ³•ä¼šåœ¨æ¯æ¬¡é‡è¯•å¤±è´¥åç­‰å¾…æ›´é•¿çš„æ—¶é—´ï¼Œä»è€Œå‡è½»æœåŠ¡å™¨çš„å‹åŠ›ï¼Œå¹¶å¢åŠ æ¶ˆæ¯æˆåŠŸå‘é€çš„æ¦‚ç‡ã€‚</p>
<p>é€šè¿‡è®¾ç½® Producer acks æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿ç”Ÿäº§è€…æ”¶åˆ° Kafka æœåŠ¡å™¨çš„ç¡®è®¤ï¼ŒçŸ¥æ™“æ¶ˆæ¯æ˜¯å¦è¢«æˆåŠŸæäº¤ã€‚</p>
<ul>
<li><strong>acks=0ï¼š</strong> ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯åä¸ä¼šç­‰å¾…ä»»ä½•ç¡®è®¤ï¼Œç›´æ¥å°†æ¶ˆæ¯è§†ä¸ºå‘é€æˆåŠŸã€‚è¿™ç§è®¾ç½®ä¸‹ï¼Œå¯èƒ½ä¼šå‡ºç°æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µï¼Œå› ä¸ºç”Ÿäº§è€…ä¸ä¼šç­‰å¾…æœåŠ¡å™¨çš„ä»»ä½•ç¡®è®¤å³è®¤ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸã€‚</li>
<li><strong>acks=1ï¼š</strong> ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯åä¼šç­‰å¾… Leader Broker çš„ç¡®è®¤ï¼Œç¡®è®¤åå³è§†ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸã€‚è¿™ç§è®¾ç½®ä¸‹ï¼Œæ¶ˆæ¯çš„å¯é æ€§å¾—åˆ°ä¸€å®šç¨‹åº¦çš„ä¿è¯ï¼Œä½†ä»æœ‰å¯èƒ½å‘ç”Ÿ Leader Broker å®•æœºå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µã€‚</li>
<li><strong>acks=allï¼š</strong> ç”Ÿäº§è€…åœ¨å‘é€æ¶ˆæ¯åä¼šç­‰å¾… Leader Broker å’Œæ‰€æœ‰å‰¯æœ¬çš„ç¡®è®¤ï¼Œç¡®è®¤åæ‰è§†ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸã€‚è¿™ç§è®¾ç½®ä¸‹ï¼Œæ¶ˆæ¯çš„å¯é æ€§å’Œä¸€è‡´æ€§å¾—åˆ°æœ€é«˜çº§åˆ«çš„ä¿è¯ï¼Œä½†åŒæ—¶ä¹Ÿä¼šå¢åŠ ç½‘ç»œå»¶è¿Ÿå’Œèµ„æºæ¶ˆè€—ã€‚</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> org.apache.kafka.clients.producer.*<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.apache.kafka.common.serialization.StringSerializer<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.Properties<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>KafkaProducerExample</span> <span style=color:#f92672>{</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String TOPIC_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;my-topic&#34;</span><span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String BOOTSTRAP_SERVERS <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;localhost:9092&#34;</span><span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        Properties props <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Properties<span style=color:#f92672>();</span>
        props<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ProducerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>BOOTSTRAP_SERVERS_CONFIG</span><span style=color:#f92672>,</span> BOOTSTRAP_SERVERS<span style=color:#f92672>);</span>
        props<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ProducerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>KEY_SERIALIZER_CLASS_CONFIG</span><span style=color:#f92672>,</span> StringSerializer<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
        props<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ProducerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>VALUE_SERIALIZER_CLASS_CONFIG</span><span style=color:#f92672>,</span> StringSerializer<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>

        <span style=color:#75715e>// è®¾ç½®é‡è¯•æ¬¡æ•°ä¸º3æ¬¡
</span><span style=color:#75715e></span>        props<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ProducerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>RETRIES_CONFIG</span><span style=color:#f92672>,</span> 3<span style=color:#f92672>);</span>

		<span style=color:#75715e>// æŒ‡æ•°é€€é¿ç®—æ³•å‚æ•°
</span><span style=color:#75715e></span>		<span style=color:#75715e>// åˆå§‹é‡è¯•é—´éš”ä¸º1ç§’
</span><span style=color:#75715e></span>		props<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ProducerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>RETRY_BACKOFF_MS_CONFIG</span><span style=color:#f92672>,</span> 1000<span style=color:#f92672>);</span>
		<span style=color:#75715e>// æœ€å¤§é‡è¯•é—´éš”ä¸º30ç§’
</span><span style=color:#75715e></span>		props<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ProducerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>RETRY_BACKOFF_MAX_MS_CONFIG</span><span style=color:#f92672>,</span> 30000<span style=color:#f92672>);</span>
		<span style=color:#75715e>// è®¾ç½® acks é…ç½®ä¸º all
</span><span style=color:#75715e></span>		properties<span style=color:#f92672>.</span><span style=color:#a6e22e>setProperty</span><span style=color:#f92672>(</span>ProducerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>ACKS_CONFIG</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;all&#34;</span><span style=color:#f92672>);</span>

        KafkaProducer<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> producer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> KafkaProducer<span style=color:#f92672>&lt;&gt;(</span>props<span style=color:#f92672>);</span>
        <span style=color:#75715e>// ... å…¶ä»–ä¸šåŠ¡é€»è¾‘
</span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><ol start=3>
<li>å¯ç”¨ Kafka æ—¥å¿—å‹ç¼©</li>
</ol>
<p>Kafka æä¾›äº†æ—¥å¿—å‹ç¼©åŠŸèƒ½ï¼Œè¿™å¯ä»¥å‡å°‘ç£ç›˜ç©ºé—´çš„ä½¿ç”¨ï¼Œå¹¶æé«˜æ¶ˆæ¯å­˜å‚¨çš„å¯é æ€§ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥å‡å°‘å› ç£ç›˜æ»¡å¯¼è‡´çš„æ¶ˆæ¯ä¸¢å¤±é£é™©ã€‚</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> org.apache.kafka.clients.producer.*<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.apache.kafka.common.serialization.StringSerializer<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.Properties<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>KafkaProducerExample</span> <span style=color:#f92672>{</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String TOPIC_NAME <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;my-topic&#34;</span><span style=color:#f92672>;</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>final</span> String BOOTSTRAP_SERVERS <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;localhost:9092&#34;</span><span style=color:#f92672>;</span>

    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        Properties props <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Properties<span style=color:#f92672>();</span>
        props<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ProducerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>BOOTSTRAP_SERVERS_CONFIG</span><span style=color:#f92672>,</span> BOOTSTRAP_SERVERS<span style=color:#f92672>);</span>
        props<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ProducerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>KEY_SERIALIZER_CLASS_CONFIG</span><span style=color:#f92672>,</span> StringSerializer<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>
        props<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ProducerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>VALUE_SERIALIZER_CLASS_CONFIG</span><span style=color:#f92672>,</span> StringSerializer<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>.</span><span style=color:#a6e22e>getName</span><span style=color:#f92672>());</span>

        <span style=color:#75715e>// å…¶ä»–è®¾ç½®...
</span><span style=color:#75715e></span>        <span style=color:#75715e>// å¯ç”¨æ—¥å¿—å‹ç¼©ï¼Œä½¿ç”¨gzipå‹ç¼©ç®—æ³•
</span><span style=color:#75715e></span>        props<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ProducerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>COMPRESSION_TYPE_CONFIG</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;gzip&#34;</span><span style=color:#f92672>);</span>
        KafkaProducer<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> producer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> KafkaProducer<span style=color:#f92672>&lt;&gt;(</span>props<span style=color:#f92672>);</span>
        <span style=color:#75715e>// ... å…¶ä»–ä¸šåŠ¡é€»è¾‘
</span><span style=color:#75715e></span>    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h3 id=kafka-æœåŠ¡ç«¯ç›¸å…³æ–¹æ¡ˆä¸æªæ–½>Kafka æœåŠ¡ç«¯ç›¸å…³æ–¹æ¡ˆä¸æªæ–½<a hidden class=anchor aria-hidden=true href=#kafka-æœåŠ¡ç«¯ç›¸å…³æ–¹æ¡ˆä¸æªæ–½>#</a></h3>
<p>åœ¨ Kafka æœåŠ¡ç«¯ï¼Œè¦ä¿è¯æ¶ˆæ¯çš„å¯é æ€§ï¼Œéœ€è¦ä»å‡ æ–¹é¢è€ƒè™‘</p>
<p><strong>åˆç†çš„é…ç½®</strong></p>
<ol>
<li>æ ¹æ®æ•°æ®é‡çº§ï¼Œé…ç½®åˆç†çš„ partition æ•°é‡ï¼Œæé«˜ååé‡ï¼Œé¿å…æ€§èƒ½ç“¶é¢ˆå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±</li>
</ol>
<p><strong>é«˜å¯ç”¨ï¼š</strong></p>
<ol>
<li><strong>å¤šå‰¯æœ¬é…ç½®ï¼š</strong> åœ¨ Kafka é›†ç¾¤ä¸­è®¾ç½®å¤šä¸ªå‰¯æœ¬ï¼Œä»¥ç¡®ä¿å³ä½¿æŸäº› Broker å‘ç”Ÿæ•…éšœï¼Œä»ç„¶èƒ½å¤Ÿä¿è¯æ¶ˆæ¯çš„å¯ç”¨æ€§å’Œä¸€è‡´æ€§</li>
<li><strong>ISRï¼ˆIn-Sync Replicasï¼‰æœºåˆ¶ï¼š</strong> ä½¿ç”¨ ISR æœºåˆ¶æ¥ç¡®ä¿æ‰€æœ‰å‰¯æœ¬ä¹‹é—´çš„åŒæ­¥æ€§ï¼Œåªæœ‰åœ¨æ‰€æœ‰ ISR ä¸­çš„å‰¯æœ¬éƒ½åŒæ­¥æˆåŠŸåæ‰è®¤ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸ</li>
<li><strong>Controller é€‰ä¸¾ï¼š</strong> é…ç½® Controller é€‰ä¸¾æœºåˆ¶ï¼Œç¡®ä¿ Kafka é›†ç¾¤ä¸­çš„ Controller èƒ½å¤ŸåŠæ—¶å¤„ç† Broker çš„æ•…éšœå’Œåˆ‡æ¢</li>
</ol>
<p><strong>æ•°æ®æŒä¹…åŒ–å’Œæ—¥å¿—ç®¡ç†ï¼š</strong></p>
<ul>
<li><strong>æ•°æ®æŒä¹…åŒ–ç­–ç•¥ï¼š</strong> é…ç½®åˆé€‚çš„æ•°æ®æŒä¹…åŒ–ç­–ç•¥ï¼Œä¾‹å¦‚ä½¿ç”¨æŒä¹…åŒ–æ—¥å¿—æ¥å­˜å‚¨æ¶ˆæ¯ï¼Œä¿è¯æ¶ˆæ¯ä¸ä¼šå› ä¸ºæœåŠ¡é‡å¯æˆ–å¼‚å¸¸å¯¼è‡´ä¸¢å¤±ã€‚</li>
<li><strong>æ—¥å¿—ç®¡ç†å’Œæ¸…ç†ï¼š</strong> å®šæœŸæ¸…ç†è¿‡æœŸçš„æ—¥å¿—æ®µï¼ˆlog segmentï¼‰ï¼Œé¿å…æ—¥å¿—æ–‡ä»¶è¿‡å¤§å¯¼è‡´ç£ç›˜ç©ºé—´ä¸è¶³ï¼ŒåŒæ—¶ç¡®ä¿æ¶ˆæ¯çš„åŠæ—¶æ¸…ç†å’Œå½’æ¡£ã€‚</li>
</ul>
<p><strong>ç›‘æ§å’Œæ•…éšœæ¢å¤ï¼š</strong></p>
<ul>
<li><strong>ç›‘æ§å’ŒæŠ¥è­¦ï¼š</strong> é…ç½®ç›‘æ§ç³»ç»Ÿï¼Œå®æ—¶ç›‘æµ‹ Kafka é›†ç¾¤çš„è¿è¡ŒçŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡ï¼Œå¹¶è®¾ç½®æŠ¥è­¦æœºåˆ¶ï¼Œåœ¨å‡ºç°å¼‚å¸¸æˆ–æ€§èƒ½ä¸‹é™æ—¶åŠæ—¶å‘ç°å¹¶å¤„ç†ã€‚</li>
<li><strong>æ•…éšœè‡ªæ„ˆï¼š</strong> é…ç½®è‡ªåŠ¨æ•…éšœæ¢å¤æœºåˆ¶ï¼Œä¾‹å¦‚ä½¿ç”¨ Kafka çš„ Controller è‡ªåŠ¨è¿›è¡Œ Broker çš„æ•…éšœæ£€æµ‹å’Œåˆ‡æ¢ï¼Œç¡®ä¿é›†ç¾¤åœ¨å‘ç”Ÿæ•…éšœæ—¶èƒ½å¤Ÿå¿«é€Ÿæ¢å¤ã€‚</li>
</ul>
<h3 id=æ¶ˆè´¹è€…ç«¯è§£å†³æ–¹æ¡ˆä¸æªæ–½>æ¶ˆè´¹è€…ç«¯è§£å†³æ–¹æ¡ˆä¸æªæ–½<a hidden class=anchor aria-hidden=true href=#æ¶ˆè´¹è€…ç«¯è§£å†³æ–¹æ¡ˆä¸æªæ–½>#</a></h3>
<p><strong>æ‰‹åŠ¨ç»´æŠ¤ offset</strong></p>
<ul>
<li>å°† <code>enable.auto.commit</code> è®¾ç½®ä¸º <code>false</code>ï¼Œå¹¶ä¸”åœ¨æ¶ˆè´¹è€…ç«¯æ‰‹åŠ¨æäº¤åç§»é‡ã€‚</li>
<li>ä½¿ç”¨è¾ƒå°çš„ <code>auto.commit.interval.ms</code> å€¼ï¼Œä»¥å‡å°‘è‡ªåŠ¨æäº¤åç§»é‡çš„æ—¶é—´é—´éš”ï¼Œæé«˜åç§»é‡çš„æäº¤é¢‘ç‡ã€‚</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#f92672>import</span> org.apache.kafka.clients.consumer.*<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> org.apache.kafka.common.TopicPartition<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> redis.clients.jedis.Jedis<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.time.Duration<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.Collections<span style=color:#f92672>;</span>
<span style=color:#f92672>import</span> java.util.Properties<span style=color:#f92672>;</span>

<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>KafkaConsumerWithRedisOffsetOnStartup</span> <span style=color:#f92672>{</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span><span style=color:#f92672>(</span>String<span style=color:#f92672>[]</span> args<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        String kafkaBootstrapServers <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;kafka-broker1:9092,kafka-broker2:9092&#34;</span><span style=color:#f92672>;</span>
        String kafkaTopic <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test-topic&#34;</span><span style=color:#f92672>;</span>
        String groupId <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;test-consumer-group&#34;</span><span style=color:#f92672>;</span>
        String redisHost <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;localhost&#34;</span><span style=color:#f92672>;</span>
        <span style=color:#66d9ef>int</span> redisPort <span style=color:#f92672>=</span> 6379<span style=color:#f92672>;</span>

        <span style=color:#75715e>// Kafka Consumer é…ç½®
</span><span style=color:#75715e></span>        Properties props <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Properties<span style=color:#f92672>();</span>
        props<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ConsumerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>BOOTSTRAP_SERVERS_CONFIG</span><span style=color:#f92672>,</span> kafkaBootstrapServers<span style=color:#f92672>);</span>
        props<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ConsumerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>GROUP_ID_CONFIG</span><span style=color:#f92672>,</span> groupId<span style=color:#f92672>);</span>
        props<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ConsumerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>KEY_DESERIALIZER_CLASS_CONFIG</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;org.apache.kafka.common.serialization.StringDeserializer&#34;</span><span style=color:#f92672>);</span>
        props<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ConsumerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>VALUE_DESERIALIZER_CLASS_CONFIG</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;org.apache.kafka.common.serialization.StringDeserializer&#34;</span><span style=color:#f92672>);</span>
        props<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ConsumerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>ENABLE_AUTO_COMMIT_CONFIG</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;false&#34;</span><span style=color:#f92672>);</span> <span style=color:#75715e>// å…³é—­è‡ªåŠ¨æäº¤åç§»é‡
</span><span style=color:#75715e></span>        props<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span>ConsumerConfig<span style=color:#f92672>.</span><span style=color:#a6e22e>AUTO_COMMIT_INTERVAL_MS_CONFIG</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;100&#34;</span><span style=color:#f92672>);</span> <span style=color:#75715e>// è®¾ç½®è‡ªåŠ¨æäº¤åç§»é‡çš„æ—¶é—´é—´éš”ä¸º 100 æ¯«ç§’
</span><span style=color:#75715e></span>
        KafkaConsumer<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> consumer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> KafkaConsumer<span style=color:#f92672>&lt;&gt;(</span>props<span style=color:#f92672>);</span>

        <span style=color:#75715e>// Redis è¿æ¥
</span><span style=color:#75715e></span>        Jedis jedis <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Jedis<span style=color:#f92672>(</span>redisHost<span style=color:#f92672>,</span> redisPort<span style=color:#f92672>);</span>

        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            <span style=color:#75715e>// ä» Redis ä¸­è·å–åç§»é‡
</span><span style=color:#75715e></span>            Map<span style=color:#f92672>&lt;</span>TopicPartition<span style=color:#f92672>,</span> Long<span style=color:#f92672>&gt;</span> offsets <span style=color:#f92672>=</span> getOffsetsFromRedis<span style=color:#f92672>(</span>jedis<span style=color:#f92672>,</span> kafkaTopic<span style=color:#f92672>,</span> groupId<span style=color:#f92672>);</span>
            <span style=color:#75715e>// è®¢é˜…ä¸»é¢˜å¹¶è®¾ç½®åç§»é‡
</span><span style=color:#75715e></span>            consumer<span style=color:#f92672>.</span><span style=color:#a6e22e>subscribe</span><span style=color:#f92672>(</span>Collections<span style=color:#f92672>.</span><span style=color:#a6e22e>singleton</span><span style=color:#f92672>(</span>kafkaTopic<span style=color:#f92672>),</span> <span style=color:#66d9ef>new</span> ConsumerRebalanceListener<span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
                <span style=color:#a6e22e>@Override</span>
                <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onPartitionsRevoked</span><span style=color:#f92672>(</span>Collection<span style=color:#f92672>&lt;</span>TopicPartition<span style=color:#f92672>&gt;</span> partitions<span style=color:#f92672>)</span> <span style=color:#f92672>{}</span>

                <span style=color:#a6e22e>@Override</span>
                <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>onPartitionsAssigned</span><span style=color:#f92672>(</span>Collection<span style=color:#f92672>&lt;</span>TopicPartition<span style=color:#f92672>&gt;</span> partitions<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>TopicPartition partition <span style=color:#f92672>:</span> partitions<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                        consumer<span style=color:#f92672>.</span><span style=color:#a6e22e>seek</span><span style=color:#f92672>(</span>partition<span style=color:#f92672>,</span> offsets<span style=color:#f92672>.</span><span style=color:#a6e22e>getOrDefault</span><span style=color:#f92672>(</span>partition<span style=color:#f92672>,</span> 0L<span style=color:#f92672>));</span>
                    <span style=color:#f92672>}</span>
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>});</span>

            <span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                ConsumerRecords<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> records <span style=color:#f92672>=</span> consumer<span style=color:#f92672>.</span><span style=color:#a6e22e>poll</span><span style=color:#f92672>(</span>Duration<span style=color:#f92672>.</span><span style=color:#a6e22e>ofMillis</span><span style=color:#f92672>(</span>100<span style=color:#f92672>));</span>
                <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>ConsumerRecord<span style=color:#f92672>&lt;</span>String<span style=color:#f92672>,</span> String<span style=color:#f92672>&gt;</span> record <span style=color:#f92672>:</span> records<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                    System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Received message: &#34;</span> <span style=color:#f92672>+</span> record<span style=color:#f92672>.</span><span style=color:#a6e22e>value</span><span style=color:#f92672>());</span>
                    <span style=color:#75715e>// å¤„ç†æ¶ˆæ¯...
</span><span style=color:#75715e></span>                    <span style=color:#75715e>// æ‰‹åŠ¨æäº¤åç§»é‡åˆ° Redis
</span><span style=color:#75715e></span>                    saveOffsetInRedis<span style=color:#f92672>(</span>jedis<span style=color:#f92672>,</span> record<span style=color:#f92672>.</span><span style=color:#a6e22e>topic</span><span style=color:#f92672>(),</span> record<span style=color:#f92672>.</span><span style=color:#a6e22e>partition</span><span style=color:#f92672>(),</span> record<span style=color:#f92672>.</span><span style=color:#a6e22e>offset</span><span style=color:#f92672>());</span>
                    <span style=color:#75715e>// æ‰‹åŠ¨æäº¤åç§»é‡åˆ° Kafka
</span><span style=color:#75715e></span>                    consumer<span style=color:#f92672>.</span><span style=color:#a6e22e>commitSync</span><span style=color:#f92672>(</span>Collections<span style=color:#f92672>.</span><span style=color:#a6e22e>singletonMap</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> TopicPartition<span style=color:#f92672>(</span>record<span style=color:#f92672>.</span><span style=color:#a6e22e>topic</span><span style=color:#f92672>(),</span> record<span style=color:#f92672>.</span><span style=color:#a6e22e>partition</span><span style=color:#f92672>()),</span> <span style=color:#66d9ef>new</span> OffsetAndMetadata<span style=color:#f92672>(</span>record<span style=color:#f92672>.</span><span style=color:#a6e22e>offset</span><span style=color:#f92672>()</span> <span style=color:#f92672>+</span> 1<span style=color:#f92672>)));</span>
                <span style=color:#f92672>}</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
            consumer<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
            jedis<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> Map<span style=color:#f92672>&lt;</span>TopicPartition<span style=color:#f92672>,</span> Long<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>getOffsetsFromRedis</span><span style=color:#f92672>(</span>Jedis jedis<span style=color:#f92672>,</span> String topic<span style=color:#f92672>,</span> String groupId<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        Map<span style=color:#f92672>&lt;</span>TopicPartition<span style=color:#f92672>,</span> Long<span style=color:#f92672>&gt;</span> offsets <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> HashMap<span style=color:#f92672>&lt;&gt;();</span>
        <span style=color:#66d9ef>for</span> <span style=color:#f92672>(</span>String key <span style=color:#f92672>:</span> jedis<span style=color:#f92672>.</span><span style=color:#a6e22e>keys</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;offset-&#34;</span> <span style=color:#f92672>+</span> topic <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;-*&#34;</span><span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
            String<span style=color:#f92672>[]</span> parts <span style=color:#f92672>=</span> key<span style=color:#f92672>.</span><span style=color:#a6e22e>split</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;-&#34;</span><span style=color:#f92672>);</span>
            <span style=color:#66d9ef>int</span> partition <span style=color:#f92672>=</span> Integer<span style=color:#f92672>.</span><span style=color:#a6e22e>parseInt</span><span style=color:#f92672>(</span>parts<span style=color:#f92672>[</span>parts<span style=color:#f92672>.</span><span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> 1<span style=color:#f92672>]);</span>
            <span style=color:#66d9ef>long</span> offset <span style=color:#f92672>=</span> Long<span style=color:#f92672>.</span><span style=color:#a6e22e>parseLong</span><span style=color:#f92672>(</span>jedis<span style=color:#f92672>.</span><span style=color:#a6e22e>get</span><span style=color:#f92672>(</span>key<span style=color:#f92672>));</span>
            offsets<span style=color:#f92672>.</span><span style=color:#a6e22e>put</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> TopicPartition<span style=color:#f92672>(</span>topic<span style=color:#f92672>,</span> partition<span style=color:#f92672>),</span> offset<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
        <span style=color:#66d9ef>return</span> offsets<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>saveOffsetInRedis</span><span style=color:#f92672>(</span>Jedis jedis<span style=color:#f92672>,</span> String topic<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> partition<span style=color:#f92672>,</span> <span style=color:#66d9ef>long</span> offset<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        String key <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;offset-&#34;</span> <span style=color:#f92672>+</span> topic <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;-&#34;</span> <span style=color:#f92672>+</span> partition<span style=color:#f92672>;</span>
        jedis<span style=color:#f92672>.</span><span style=color:#a6e22e>set</span><span style=color:#f92672>(</span>key<span style=color:#f92672>,</span> String<span style=color:#f92672>.</span><span style=color:#a6e22e>valueOf</span><span style=color:#f92672>(</span>offset<span style=color:#f92672>));</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h2 id=æ€»ç»“>æ€»ç»“<a hidden class=anchor aria-hidden=true href=#æ€»ç»“>#</a></h2>
<p>æ€»å¾—æ¥è¯´ï¼Œå…³äºæ¶ˆæ¯å¯é æ€§çš„ä¿è¯ï¼Œéœ€è¦ä»ç”Ÿäº§ç«¯ã€æœåŠ¡ç«¯ã€æ¶ˆè´¹ç«¯ä¸‰ä¸ªæ–¹é¢ç»¼åˆè€ƒè™‘ï¼Œä¸æ˜¯ä»…ä»…ä¸€ä¸ªæ–¹é¢çš„é—®é¢˜ã€‚</p>
<h2 id=æ‹“å±•>æ‹“å±•<a hidden class=anchor aria-hidden=true href=#æ‹“å±•>#</a></h2>
<p><strong>Kafka å®˜æ–¹å¸¸ç”¨å·¥å…·</strong></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#Â æŸ¥çœ‹æŸä¸ªtopicçš„messageæ•°é‡</span>
$Â ./kafka-run-class.shÂ kafka.tools.GetOffsetShellÂ --broker-listÂ localhost:9092Â --topicÂ test_topic
<span style=color:#75715e>#Â æŸ¥çœ‹consumerÂ Groupåˆ—è¡¨</span>
$Â ./kafka-consumer-groups.shÂ Â --listÂ Â --bootstrap-serverÂ 192.168.88.108:9092
<span style=color:#75715e>#Â æŸ¥çœ‹Â offsetÂ æ¶ˆè´¹æƒ…å†µ</span>
$Â ./kafka-consumer-groups.shÂ --bootstrap-serverÂ localhost:9092Â --groupÂ console-consumer-1152Â --describe
GROUPÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â TOPICÂ Â Â Â Â Â Â Â Â Â Â PARTITIONÂ Â CURRENT-OFFSETÂ Â LOG-END-OFFSETÂ Â LAGÂ Â Â Â Â Â Â Â Â Â Â Â Â CONSUMER-IDÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â HOSTÂ Â Â Â Â Â Â Â Â Â Â Â CLIENT-ID
console-consumer-1152Â test_topicÂ Â Â Â Â Â 0Â Â Â Â Â Â Â Â Â Â -Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 4Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â -Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â consumer-console-consumer-1152-1-2703ea2b-b62d-4cfd-8950-34e8c321b942Â /127.0.0.1Â Â Â Â Â Â consumer-console-consumer-1152-1
</code></pre></div><p><strong>KafkaÂ  æ—¥å¿—åˆ·ç›˜æœºåˆ¶</strong></p>
<pre tabindex=0><code>#Â æ¨èé‡‡ç”¨é»˜è®¤å€¼ï¼Œå³ä¸é…ç½®è¯¥é…ç½®ï¼Œäº¤ç”±æ“ä½œç³»ç»Ÿè‡ªè¡Œå†³å®šä½•æ—¶è½ç›˜ï¼Œä»¥æå‡æ€§èƒ½ã€‚
#Â é’ˆå¯¹ broker é…ç½®ï¼š
log.flush.interval.messages=10000Â #Â æ—¥å¿—è½ç›˜æ¶ˆæ¯æ¡æ•°é—´éš”ï¼Œå³æ¯æ¥æ”¶åˆ°ä¸€å®šæ¡æ•°æ¶ˆæ¯ï¼Œå³è¿›è¡Œlogè½ç›˜ã€‚
log.flush.interval.ms=1000Â Â Â Â Â Â Â Â #Â æ—¥å¿—è½ç›˜æ—¶é—´é—´éš”ï¼Œå•ä½msï¼Œå³æ¯éš”ä¸€å®šæ—¶é—´ï¼Œå³è¿›è¡Œlogè½ç›˜ã€‚

#Â é’ˆå¯¹ topic é…ç½®ï¼š
flush.messages.flush.ms=1000Â Â #Â topicä¸‹æ¯1såˆ·ç›˜
flush.messages=1Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â topicä¸‹æ¯ä¸ªæ¶ˆæ¯éƒ½è½ç›˜

#Â æŸ¥çœ‹Â LinuxÂ åå°çº¿ç¨‹æ‰§è¡Œé…ç½®
$Â sysctlÂ -aÂ |Â grepÂ dirty
vm.dirty_background_bytesÂ =Â 0
vm.dirty_background_ratioÂ =Â 10Â Â Â Â Â Â #Â è¡¨ç¤ºå½“è„é¡µå æ€»å†…å­˜çš„çš„ç™¾åˆ†æ¯”è¶…è¿‡è¿™ä¸ªå€¼æ—¶ï¼Œåå°çº¿ç¨‹å¼€å§‹åˆ·æ–°è„é¡µã€‚
vm.dirty_bytesÂ =Â 0
vm.dirty_expire_centisecsÂ =Â 3000Â Â Â Â #Â è¡¨ç¤ºè„æ•°æ®å¤šä¹…ä¼šè¢«åˆ·æ–°åˆ°ç£ç›˜ä¸Šï¼ˆ30ç§’ï¼‰ã€‚
vm.dirty_ratioÂ =Â 20
vm.dirty_writeback_centisecsÂ =Â 500Â Â #Â è¡¨ç¤ºå¤šä¹…å”¤é†’ä¸€æ¬¡åˆ·æ–°è„é¡µçš„åå°çº¿ç¨‹ï¼ˆï¼•ç§’ï¼‰ã€‚
vm.dirtytime_expire_secondsÂ =Â 43200
</code></pre>
</div>
<link href=https://comment.fascloud.org/dist/Artalk.css rel=stylesheet>
<style>.dark .atk-main-editor{background-color:#37383e!important;border:1px solid #555660!important}.dark .artalk{color:#bdbdbe!important}.dark .atk-main-editor>.atk-textarea-wrap>.atk-textarea{background-color:#37383e!important;color:#bdbdbe!important}.dark .atk-editor-plug-emoticons>.atk-grp-switcher{background:#37383e!important;border-top:1px solid #555660!important;border-bottom:1px solid #555660!important}.dark .atk-editor-plug-emoticons>.atk-grp-switcher>span:hover,.dark .atk-editor-plug-emoticons>.atk-grp-switcher>span.active{background:#262629!important}.dark .atk-main-editor>.atk-plug-panel-wrap{border-top:1px solid #555660!important}.dark .atk-comment>.atk-main>.atk-header .badge,.atk-comment>.atk-main>.atk-header .atk-ua,.atk-comment>.atk-main>.atk-header .atk-pinned-badge,.atk-comment>.atk-main>.atk-header .atk-region-badge,.atk-comment>.atk-main>.atk-header .atk-badge{color:#bdc6d9!important;background:#000!important}.dark .atk-main-editor>.atk-textarea-wrap>.atk-send-reply{background:rgb(134 134 134/75%)!important}.comment-split-line{text-align:center;font-size:14px;border-bottom:1px solid #eaecef;margin:50px 0;height:0}.comment-split-line::after{content:"è¯„è®º";background-color:#ececec;border-radius:10px;padding:0 10px;position:relative;top:-10px;color:#6a737d}.dark .comment-split-line::after{background-color:#37383e;color:#bdc6d9}.dark .comment-split-line{border-bottom:1px solid #555660}</style>
<script src=https://comment.fascloud.org/dist/Artalk.js></script>
<div class=comment-split-line></div>
<div id=Comments></div>
<script>Artalk.init({el:'#Comments',pageKey:'',pageTitle:'',server:'https://comment.fascloud.org/',site:'blog-hushuo'})</script>
</article>
</main>
<footer class=footer>
<span>&copy; 2024 <a href=https://blog.zhangyingwei.com/>èƒ¡è¯´</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
<span>
è®¢é˜…
<a href=/index.xml rel=noopener target=_blank>RSS</a>
</span>
</footer>
<a href=# aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script></script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode;b.classList.add('font-activate');const a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script></body>
</html>