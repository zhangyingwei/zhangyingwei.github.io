---
title: å¦‚æœæˆ‘ä»¬æƒ³å®ç°ä¸€ä¸ª WAFä¹‹ -- WAF æ˜¯æ€ä¹ˆå·¥ä½œçš„
date: 2024-01-31T10:33:20+08:00
draft: true
hasCJKLanguage: true
tags:
  - å®‰å…¨
  - waf
  - ç½‘ç»œå®‰å…¨
series:
  - ç½‘ç»œä¸å®‰å…¨ç³»åˆ—
categories:
  - ç»éªŒåˆ†äº«
  - ç½‘ç»œå®‰å…¨
keywords:
  - å®‰å…¨
  - ç½‘ç»œå®‰å…¨
  - å¼ è‹±ä¼Ÿ
  - å¼ è‹±ä¼Ÿçš„ä¸ªäººåšå®¢
  - Obsidian
  - SQLæ³¨å…¥
  - waf
  - èƒ¡è¯´
aliases:
---

æƒ³è¦äº†è§£ WAF æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼ŒåŠ¿å¿…è¦å…ˆäº†è§£ä¸€ä¸‹ WAF çš„å†…å®¹æ„æˆã€‚

![image.png](https://hushuo.zhangyingwei.com/20240131105742.png)

åœ¨ä¸Šå›¾ä¸­ï¼Œæ ¸å¿ƒåŠŸèƒ½åŸºæœ¬å¯ä»¥æ‹†åˆ†ä¸ºå››å¤§å—ï¼š

1. æµé‡é‡‡é›†/è¿‡æ»¤/è§£æ
2. é»‘ç™½åå•
3. è§„åˆ™å¼•æ“
4. å‘Šè­¦å¤„ç†

s æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æŒ‰ç…§è¿™å››ä¸ªæ­¥éª¤ï¼Œæ€è€ƒå¦‚ä½•å®ç°ä¸€ä¸ªç®€æ˜“çš„ WAF ã€‚

> PS: ä¸ºäº†è¡¨è¾¾æ ¸å¿ƒæ€æƒ³ã€ç®€åŒ–ä»£ç å¤æ‚åº¦ã€‚æœ¬ç¤ºä¾‹ä½¿ç”¨ Python3.7 è¿›è¡Œç¼–ç ï¼Œä»…å®ç°æ ¸å¿ƒé€»è¾‘ã€‚ä¸ä¿è¯ä»£ç å¯ä»¥æœ€ç»ˆè¿è¡Œã€‚ä¸»è¦ç›®æ ‡æ˜¯è¡¨è¾¾å…·ä½“çš„ç¼–ç é€»è¾‘å’ŒæŠ€æœ¯ç»†èŠ‚ã€‚

> PS: ä»¥ä¸‹ä»£ç ä¸­é‡‡ç”¨çš„æ–¹æ³•ä¸ä»£è¡¨æœ€ä¼˜è§£ï¼Œä»…è¡¨ç¤ºä¸šåŠ¡é€»è¾‘ã€‚

# ğŸ­ æµé‡é‡‡é›†/è¿‡æ»¤/è§£æ

åœ¨ä»¥ä¸‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬æ¨¡æ‹Ÿ WAF ä¸­çš„æµé‡é‡‡é›†ã€è¿‡æ»¤ã€è§£æè¡Œä¸ºã€‚ä»ç½‘å¡ä¸­é‡‡é›†æµé‡æ•°æ®åŒ…ï¼Œç„¶åå¯¹æ•°æ®åŒ…è¿›è¡Œè¿‡æ»¤ï¼Œè¿‡æ»¤å·¥ä½œä¼šåˆæ­¥è¿‡æ»¤å‡º HTTP åè®®æµé‡ï¼Œç„¶åå¯¹æ•°æ®åŒ…è¿›è¡Œé»‘ç™½åå•è¿‡æ»¤ï¼Œæœ€ç»ˆæ»¡è¶³æ¡ä»¶çš„æ•°æ®åŒ…ä¼šæ ¹æ® HTTPReques å’Œ HTTPResponse è¿›è¡Œè§£æï¼Œè·å– HTTP åè®®ä¸­çš„å„ä¸ªå…³é”®ä¿¡æ¯ä»¥ä¾›åç»­è§„åˆ™å¼•æ“è¿›è¡Œè¯†åˆ«å’Œè¿‡æ»¤ã€‚

```python
from scapy.all import *
from scapy.layers.http import *

def collect_traffic():
    """é‡‡é›†ç½‘å¡æµé‡"""
    show_interfaces()
    sniff(prn=filter_http_traffic)

def filter_http_traffic(packet):
    """è¿‡æ»¤HTTPæµé‡"""
    if packet.haslayer(HTTPRequest) or packet.haslayer(HTTPResponse):
        if filter_by_white_ip_list(packet):
            # pass ç›´æ¥æ”¾é€šè¯¥æ•°æ®åŒ…
            pass
        elif filter_by_black_ip_list(packet):
            # prevent ç›´æ¥é˜»æ­¢è¯¥æ•°æ®åŒ…
            pass
        else:
            parse_http_traffic(packet)

def filter_by_black_ip_list(packet):
    # æ ¹æ®é»‘ç™½åå•ï¼Œè¿›è¡Œæ•°æ®åŒ…è¿‡æ»¤
    if packet.haslayer(HTTPRequest):
        black_ip_list = []
        sip = packet[IP].src
        return sip in black_ip_list

def filter_by_white_ip_list(packet):
    # æ ¹æ®é»‘ç™½åå•ï¼Œè¿›è¡Œæ•°æ®åŒ…è¿‡æ»¤
    white_ip_list = []
    sip = packet[IP].src
    return sip in white_ip_list

def parse_http_traffic(http_packet):
    """è§£æHTTPæµé‡ä¿¡æ¯ä¸ºrequestå’Œresponse"""
    if http_packet.haslayer(HTTPRequest):
        request = HTTPRequest()
        request.add_payload(http_packet)
        print(f"+[+] {request.Host} Requested {request.Path} with {request.Method}")
        for field in request.fields_desc:
            if request.payload.getfieldval(field.name) is not None:
                print(f"\t{field.name}\t{request.payload.getfieldval(field.name)}")
        if http_packet.haslayer(Raw) and request.payload.Method == "POST":
            print(f"[*] Some useful Raw data: {http_packet[Raw].load}")
    if http_packet.haslayer(HTTPResponse):
        try:
            response = HTTPResponse()
            response.add_payload(http_packet)
            print(f"-[+] Response {response}")
            for field in response.fields_desc:
                if response.payload.getfieldval(field.name):
                    print(f"\t{field.name}\t{response.payload.getfieldval(field.name)}")
        except Exception as e:
            print(f"[!] Some exception. {e}")

def main():
    """ä¸»å‡½æ•°"""
    collect_traffic()

if __name__ == "__main__":
    main()
```

# ğŸ° WAF ä¸è§„åˆ™å¼•æ“

å¸¸è§„çš„è§„åˆ™å¼•æ“ï¼Œé€šè¿‡åŸºäºæ­£åˆ™è¡¨è¾¾å¼ã€æ¨¡ç³ŠåŒ¹é…ã€é»‘ç™½åå•ã€æœºå™¨å­¦ä¹ ç­‰

- **æ­£åˆ™è¡¨è¾¾å¼**ï¼š æ­£åˆ™è¡¨è¾¾å¼æ˜¯ä¸€ç§å­—ç¬¦ä¸²åŒ¹é…æŠ€æœ¯ï¼Œå¯ä»¥ç”¨æ¥æ£€æµ‹ç‰¹å®šæ¨¡å¼çš„å­—ç¬¦ä¸²ã€‚WAF å¯ä»¥ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥æ£€æµ‹æ¶æ„ URLã€æ¶æ„ HTTP å¤´ã€æ¶æ„ HTTP Body ç­‰
- **æ¨¡ç³ŠåŒ¹é…:**Â  æ¨¡ç³ŠåŒ¹é…æ˜¯ä¸€ç§å­—ç¬¦ä¸²åŒ¹é…æŠ€æœ¯ï¼Œå¯ä»¥ç”¨æ¥æ£€æµ‹ä¸ç»™å®šå­—ç¬¦ä¸²ç›¸ä¼¼ä½†ä¸å®Œå…¨ç›¸åŒçš„å­—ç¬¦ä¸²ã€‚WAF å¯ä»¥ä½¿ç”¨æ¨¡ç³ŠåŒ¹é…æ¥æ£€æµ‹å˜å½¢çš„æ¶æ„ URLã€æ¶æ„ HTTP å¤´ã€æ¶æ„ HTTP body ç­‰
- **é»‘åå•:**Â  é»‘åå•æ˜¯ä¸€ç§å·²çŸ¥æ¶æ„ IP åœ°å€ã€æ¶æ„ URLã€æ¶æ„ HTTP å¤´ã€æ¶æ„ HTTP Body ç­‰çš„åˆ—è¡¨ã€‚WAF å¯ä»¥ä½¿ç”¨é»‘åå•æ¥é˜»æ­¢æ¥è‡ªæ¶æ„æ¥æºçš„æµé‡
- **ç™½åå•:**Â  ç™½åå•æ˜¯ä¸€ç§å·²çŸ¥å®‰å…¨ IP åœ°å€ã€å®‰å…¨ URLã€å®‰å…¨ HTTP å¤´ã€å®‰å…¨ HTTP Body ç­‰çš„åˆ—è¡¨ã€‚WAF å¯ä»¥ä½¿ç”¨ç™½åå•æ¥åªå…è®¸æ¥è‡ªå®‰å…¨æ¥æºçš„æµé‡
- **æœºå™¨å­¦ä¹ :**Â WAF å¯ä»¥ä½¿ç”¨æœºå™¨å­¦ä¹ æ¥è¯†åˆ«æ–°çš„æ¶æ„æµé‡æ¨¡å¼ï¼Œå¹¶åŠæ—¶åšå‡ºå“åº”

å…¶ä¸­ï¼Œæ­£åˆ™è¡¨è¾¾å¼ã€æ¨¡ç³ŠåŒ¹é…ã€é»‘åå•ã€ç™½åå•ç­‰è§„åˆ™å¼•æ“é€šå¸¸ç”± WAF å‚å•†é¢„å…ˆé…ç½®å¥½ï¼Œå®‰å…¨åˆ†æå¸ˆå¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œè°ƒæ•´å’Œä¿®æ”¹ã€‚è€Œæœºå™¨å­¦ä¹ è§„åˆ™å¼•æ“é€šå¸¸éœ€è¦å®‰å…¨åˆ†æå¸ˆè¿›è¡Œè®­ç»ƒå’Œé…ç½®ï¼Œæ‰èƒ½æœ‰æ•ˆåœ°è¯†åˆ«æ¶æ„æµé‡ã€‚

```python
def rule_filter(request,response):  
    return (regx_rule_filter(request,response)  
            and match_rule_filter(request,response)  
            and black_list_rule_set(request,response)  
            and white_list_rule_set(request,response)  
            and ml_filter(request,response))  
  
def regx_rule_filter(request,response):  
    # æ­£åˆ™è¿‡æ»¤  
    rule_sets = []  
    return True  
  
def match_rule_filter(request,response):  
    # æ¨¡ç³ŠåŒ¹é…è¿‡æ»¤  
    rule_sets = []  
    return True  
  
def black_list_rule_set(request,response):  
    # é»‘åå•è¿‡æ»¤  
    black_list = []  
    return True  
  
def white_list_rule_set(request,response):  
    # ç™½åå•è¿‡æ»¤  
    white_list = []  
    return True  
  
def ml_filter(request,response):  
    # æœºå™¨å­¦ä¹ è¿‡æ»¤  
    return True
```


# ğŸ² WAF å¦‚ä½•å¤„ç†å‘Šè­¦

ç¼–å†™å¤„ç†å‘Šè­¦é€»è¾‘

# ğŸ ä¸€ä¸ªç®€å•çš„ WAF

ä»£ç æ•´åˆ

# ğŸ WAF æ‰©å±•åŠŸèƒ½

æ•´åˆå…¶ä»–åŠŸèƒ½
